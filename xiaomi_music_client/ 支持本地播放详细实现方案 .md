å¥½çš„ï¼Œè®©æˆ‘åˆ†æä¸€ä¸‹è¿™ä¸¤ä¸ªå‘½ä»¤ï¼

## ğŸ“Š **å‘½ä»¤åˆ†æ**

### 1ï¸âƒ£ **Range è¯·æ±‚æ”¯æŒ** âœ… **éå¸¸å¥½ï¼**

```bash
Range: bytes=10639624-11029093
If-Range: "be2688b5bdc6bd40f80376e3e2bb25b1"
```

**åˆ†æï¼š**
- âœ… å‘½ä»¤ä¸­åŒ…å«äº† `Range` å¤´ï¼Œè¯´æ˜æµè§ˆå™¨åœ¨å®é™…æ’­æ”¾æ—¶ä½¿ç”¨äº†èŒƒå›´è¯·æ±‚
- âœ… `If-Range` å¤´è¡¨ç¤ºæœåŠ¡å™¨æ”¯æŒ ETag å’Œæ¡ä»¶èŒƒå›´è¯·æ±‚
- âœ… **ç»“è®ºï¼šæœåŠ¡å™¨æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œè¿›åº¦æ¡æ‹–åŠ¨åŠŸèƒ½å¯ä»¥å®ç°ï¼**

**è¿™æ„å‘³ç€ï¼š**
- ç”¨æˆ·å¯ä»¥æ‹–åŠ¨è¿›åº¦æ¡åˆ°ä»»æ„ä½ç½®
- ä¸éœ€è¦ä»å¤´ä¸‹è½½æ•´ä¸ªæ–‡ä»¶
- ç½‘ç»œä¸­æ–­åå¯ä»¥ç»­ä¼ 
- just_audio å¯ä»¥å®Œç¾æ”¯æŒ

---

### 2ï¸âƒ£ **è®¤è¯è¦æ±‚** âœ… **ä¸éœ€è¦ Basic Auth**

```bash
# åªæœ‰ Cookieï¼Œæ²¡æœ‰ -u å‚æ•°
Cookie: _ga=GA1.1.1781738758.1759547660; ...
```

**åˆ†æï¼š**
- âœ… ä¸¤ä¸ªæ¥å£éƒ½æ²¡æœ‰ä½¿ç”¨ Basic Auth (`-u username:password`)
- âœ… åªä½¿ç”¨äº† Cookie è¿›è¡Œä¼šè¯ç®¡ç†
- âœ… **ç»“è®ºï¼šä¸éœ€è¦åœ¨æ¯ä¸ªè¯·æ±‚ä¸­æ·»åŠ  Basic Auth å¤´ï¼**

**è¿™æ„å‘³ç€ï¼š**
- just_audio å¯ä»¥ç›´æ¥æ’­æ”¾ URLï¼Œä¸éœ€è¦é¢å¤–é…ç½®è®¤è¯
- å¦‚æœéœ€è¦ Cookieï¼Œå¯ä»¥é€šè¿‡è‡ªå®šä¹‰ headers ä¼ é€’

---

### 3ï¸âƒ£ **æ— ç‰¹æ®Šé™åˆ¶** âœ… **å®Œç¾**

---

## ğŸ‰ **æœ€ç»ˆç»“è®ºï¼šæ–¹æ¡ˆå®Œå…¨å¯è¡Œï¼**

æ‰€æœ‰æŠ€æœ¯æ¡ä»¶éƒ½æ»¡è¶³ï¼š
- âœ… æ”¯æŒ Range è¯·æ±‚ â†’ è¿›åº¦æ¡æ‹–åŠ¨ OK
- âœ… ä¸éœ€è¦ Basic Auth â†’ æ’­æ”¾å™¨é›†æˆç®€å•
- âœ… æ— ç‰¹æ®Šé™åˆ¶ â†’ å®ç°çµæ´»

---

## ğŸ“ **è¯¦ç»†å®ç°æ–¹æ¡ˆ**

ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹è®¨è®ºå…·ä½“å®ç°äº†ã€‚è®©æˆ‘ç»™ä½ ä¸€ä¸ªå®Œæ•´çš„æ¶æ„è®¾è®¡ï¼š

### ğŸ—ï¸ **æ¶æ„è®¾è®¡**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PlaybackProvider                    â”‚
â”‚  (ç»Ÿä¸€çš„æ’­æ”¾æ§åˆ¶çŠ¶æ€ç®¡ç†)                        â”‚
â”‚                                                   â”‚
â”‚  - currentPlaybackMode: remote | local           â”‚
â”‚  - currentMusic                                  â”‚
â”‚  - isPlaying                                     â”‚
â”‚  - progress                                      â”‚
â”‚  - volume                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
        æ ¹æ® playbackMode è·¯ç”±
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                       â”‚
    â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Remote     â”‚     â”‚   Local     â”‚
â”‚  Playback   â”‚     â”‚  Playback   â”‚
â”‚  Service    â”‚     â”‚  Service    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                       â”‚
    â–¼                       â–¼
æœåŠ¡å™¨API              AudioPlayer
(ç°æœ‰å®ç°)            (just_audio)
```

---

### ğŸ“¦ **éœ€è¦æ–°å¢çš„æ–‡ä»¶**

```
lib/
â”œâ”€â”€ data/
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ local_playback_service.dart  ğŸ†• æœ¬åœ°æ’­æ”¾æœåŠ¡
â”‚       â””â”€â”€ playback_strategy.dart       ğŸ†• æ’­æ”¾ç­–ç•¥æ¥å£
â”‚
â””â”€â”€ presentation/
    â””â”€â”€ providers/
        â”œâ”€â”€ playback_provider.dart       âœï¸ éœ€è¦ä¿®æ”¹
        â””â”€â”€ device_provider.dart         âœï¸ éœ€è¦ä¿®æ”¹
```

---

### ğŸ¯ **æ ¸å¿ƒç±»è®¾è®¡**

#### **1. PlaybackStrategy æ¥å£**ï¼ˆç­–ç•¥æ¨¡å¼ï¼‰

```dart
// lib/data/services/playback_strategy.dart
abstract class PlaybackStrategy {
  // æ’­æ”¾æ§åˆ¶
  Future<void> play();
  Future<void> pause();
  Future<void> next();
  Future<void> previous();
  Future<void> seekTo(int seconds);
  Future<void> setVolume(int volume);
  
  // æ’­æ”¾æŒ‡å®šéŸ³ä¹
  Future<void> playMusic({
    required String musicName,
    String? musicId,
    String? url,
  });
  
  // è·å–å½“å‰çŠ¶æ€
  Stream<PlaybackState> get stateStream;
  
  // é‡Šæ”¾èµ„æº
  Future<void> dispose();
}
```

#### **2. RemotePlaybackStrategy**ï¼ˆè¿œç¨‹æ§åˆ¶ï¼‰

```dart
// lib/data/services/remote_playback_strategy.dart
class RemotePlaybackStrategy implements PlaybackStrategy {
  final MusicApiService apiService;
  final String deviceId;
  
  // ç°æœ‰çš„è¿œç¨‹æ§åˆ¶é€»è¾‘
  // åŸºæœ¬å°±æ˜¯æŠŠ PlaybackProvider çš„ç°æœ‰å®ç°æ¬è¿‡æ¥
  
  @override
  Future<void> play() async {
    await apiService.resumeMusic(did: deviceId);
  }
  
  // ... å…¶ä»–æ–¹æ³•
}
```

#### **3. LocalPlaybackStrategy**ï¼ˆæœ¬åœ°æ’­æ”¾ï¼‰ğŸ†•

```dart
// lib/data/services/local_playback_strategy.dart
class LocalPlaybackStrategy implements PlaybackStrategy {
  final AudioPlayer _player = AudioPlayer();
  final MusicApiService apiService;
  
  List<Music> _playlist = [];
  int _currentIndex = 0;
  
  @override
  Future<void> playMusic({
    required String musicName,
    String? musicId,
    String? url,
  }) async {
    String playUrl = url ?? '';
    
    // å¦‚æœæ²¡æœ‰URLï¼Œè¯´æ˜æ˜¯æœåŠ¡å™¨éŸ³ä¹ï¼Œéœ€è¦è·å–
    if (playUrl.isEmpty) {
      final response = await apiService.getMusicInfo(name: musicName);
      playUrl = response['url'];
    }
    
    // ä½¿ç”¨ just_audio æ’­æ”¾
    await _player.setUrl(playUrl);
    await _player.play();
  }
  
  @override
  Future<void> pause() async {
    await _player.pause();
  }
  
  @override
  Future<void> play() async {
    await _player.play();
  }
  
  @override
  Future<void> next() async {
    if (_currentIndex < _playlist.length - 1) {
      _currentIndex++;
      await playMusic(musicName: _playlist[_currentIndex].name);
    }
  }
  
  @override
  Future<void> seekTo(int seconds) async {
    await _player.seek(Duration(seconds: seconds));
  }
  
  @override
  Future<void> setVolume(int volume) async {
    await _player.setVolume(volume / 100);
  }
  
  @override
  Stream<PlaybackState> get stateStream {
    // ç›‘å¬æ’­æ”¾å™¨çŠ¶æ€å˜åŒ–ï¼Œè½¬æ¢ä¸º PlaybackState
    return _player.playerStateStream.map((state) {
      // ... è½¬æ¢é€»è¾‘
    });
  }
}
```

---

### ğŸ”„ **è®¾å¤‡åˆ‡æ¢é€»è¾‘**

#### **Device æ¨¡å‹æ‰©å±•**

```dart
// lib/data/models/device.dart
@JsonSerializable()
class Device {
  final String id;
  final String name;
  final String? type;  // 'speaker' | 'local'
  final bool? isOnline;
  final String? ip;
  
  // åˆ¤æ–­æ˜¯å¦ä¸ºæœ¬åœ°è®¾å¤‡
  bool get isLocalDevice => id == 'local_device';
  
  // é™æ€å·¥å‚ï¼šåˆ›å»ºæœ¬åœ°è®¾å¤‡
  static Device get localDevice => Device(
    id: 'local_device',
    name: 'æœ¬æœºæ’­æ”¾',
    type: 'local',
    isOnline: true,
  );
}
```

#### **DeviceProvider ä¿®æ”¹**

```dart
// lib/presentation/providers/device_provider.dart
class DeviceNotifier extends StateNotifier<DeviceState> {
  
  Future<void> loadDevices() async {
    // 1. ä»æœåŠ¡å™¨è·å–éŸ³ç®±è®¾å¤‡
    final serverDevices = await apiService.getSettings(needDeviceList: true);
    
    // 2. åœ¨åˆ—è¡¨æœ€å‰é¢æ’å…¥"æœ¬æœº"
    final allDevices = [
      Device.localDevice,  // ğŸ†• æœ¬æœºè®¾å¤‡
      ...serverDevices,
    ];
    
    state = state.copyWith(devices: allDevices);
    
    // 3. å¦‚æœæ²¡æœ‰é€‰ä¸­è®¾å¤‡ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªåœ¨çº¿è®¾å¤‡
    if (state.selectedDeviceId == null) {
      final firstOnline = allDevices.firstWhere(
        (d) => d.isOnline == true,
        orElse: () => allDevices.first,
      );
      state = state.copyWith(selectedDeviceId: firstOnline.id);
    }
  }
}
```

#### **PlaybackProvider ä¿®æ”¹**

```dart
// lib/presentation/providers/playback_provider.dart
class PlaybackNotifier extends StateNotifier<PlaybackState> {
  PlaybackStrategy? _currentStrategy;
  
  // ç›‘å¬è®¾å¤‡åˆ‡æ¢
  void _onDeviceChanged(String? deviceId) {
    if (deviceId == null) return;
    
    final device = ref.read(deviceProvider).devices
        .firstWhere((d) => d.id == deviceId);
    
    // åˆ‡æ¢æ’­æ”¾ç­–ç•¥
    _switchStrategy(device);
  }
  
  Future<void> _switchStrategy(Device device) async {
    // 1. ä¿å­˜å½“å‰çŠ¶æ€
    final currentMusic = state.currentMusic;
    final currentProgress = state.currentMusic?.offset ?? 0;
    
    // 2. åœæ­¢å½“å‰æ’­æ”¾
    await _currentStrategy?.dispose();
    
    // 3. åˆ›å»ºæ–°ç­–ç•¥
    if (device.isLocalDevice) {
      _currentStrategy = LocalPlaybackStrategy(
        apiService: ref.read(apiServiceProvider)!,
      );
    } else {
      _currentStrategy = RemotePlaybackStrategy(
        apiService: ref.read(apiServiceProvider)!,
        deviceId: device.id,
      );
    }
    
    // 4. æ¢å¤æ’­æ”¾ï¼ˆå¯é€‰ï¼‰
    if (currentMusic != null) {
      await _resumePlaybackAfterSwitch(currentMusic, currentProgress);
    }
  }
  
  Future<void> _resumePlaybackAfterSwitch(
    PlayingMusic music,
    int progress,
  ) async {
    // å°è¯•åœ¨æ–°è®¾å¤‡ä¸Šæ’­æ”¾ç›¸åŒçš„æ­Œæ›²
    try {
      await _currentStrategy?.playMusic(
        musicName: music.curMusic ?? '',
        // ... å…¶ä»–å‚æ•°
      );
      
      // å°è¯•æ¢å¤è¿›åº¦
      if (progress > 0) {
        await _currentStrategy?.seekTo(progress);
      }
    } catch (e) {
      print('åˆ‡æ¢è®¾å¤‡åæ¢å¤æ’­æ”¾å¤±è´¥: $e');
    }
  }
  
  // ç»Ÿä¸€çš„æ§åˆ¶æ¥å£
  Future<void> play() async {
    await _currentStrategy?.play();
  }
  
  Future<void> pause() async {
    await _currentStrategy?.pause();
  }
  
  // ... å…¶ä»–æ§åˆ¶æ–¹æ³•
}
```

---

### ğŸ¨ **UI å±‚æ”¹åŠ¨ï¼ˆæå°‘ï¼‰**

#### **è®¾å¤‡é€‰æ‹©å™¨å›¾æ ‡åŒºåˆ†**

```dart
// lib/presentation/pages/control_panel_page.dart
ListTile(
  leading: Icon(
    device.isLocalDevice 
        ? Icons.phone_android_rounded  // æœ¬æœºå›¾æ ‡
        : Icons.speaker_group_rounded,  // éŸ³ç®±å›¾æ ‡
    color: (device.isOnline ?? false)
        ? Colors.greenAccent
        : onSurfaceColor.withOpacity(0.4),
  ),
  title: Text(device.name),
  // ... å…¶ä»–ä»£ç ä¸å˜
)
```

**å…¶ä»– UI å®Œå…¨ä¸éœ€è¦æ”¹åŠ¨ï¼** å› ä¸ºéƒ½æ˜¯é€šè¿‡ PlaybackProvider ç»Ÿä¸€æ¥å£è°ƒç”¨ã€‚

---

### ğŸ“‹ **å®ç°æ­¥éª¤**

#### **Phase 1ï¼šåŸºç¡€æ¡†æ¶**ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
1. âœ… åˆ›å»º `PlaybackStrategy` æ¥å£
2. âœ… å®ç° `LocalPlaybackStrategy`ï¼ˆæœ¬åœ°æ’­æ”¾ï¼‰
3. âœ… é‡æ„ `RemotePlaybackStrategy`ï¼ˆç°æœ‰é€»è¾‘ï¼‰
4. âœ… ä¿®æ”¹ `Device` æ¨¡å‹ï¼Œæ·»åŠ æœ¬åœ°è®¾å¤‡
5. âœ… ä¿®æ”¹ `DeviceProvider`ï¼Œæ’å…¥æœ¬åœ°è®¾å¤‡

#### **Phase 2ï¼šé›†æˆæ’­æ”¾å™¨**ï¼ˆå¯ç”¨ï¼‰
6. âœ… æ·»åŠ  `just_audio` ä¾èµ–
7. âœ… å®ç°åŸºæœ¬æ’­æ”¾æ§åˆ¶ï¼ˆæ’­æ”¾/æš‚åœ/ä¸Šä¸‹æ›²ï¼‰
8. âœ… å®ç°æœåŠ¡å™¨éŸ³ä¹æ’­æ”¾ï¼ˆé€šè¿‡ `/musicinfo`ï¼‰
9. âœ… å®ç°åœ¨çº¿éŸ³ä¹æ’­æ”¾ï¼ˆç›´æ¥ä½¿ç”¨ URLï¼‰
10. âœ… å®ç°è¿›åº¦ç›‘å¬å’Œæ›´æ–°

#### **Phase 3ï¼šå®Œå–„åŠŸèƒ½**ï¼ˆæµç•…ï¼‰
11. âœ… å®ç°è®¾å¤‡åˆ‡æ¢é€»è¾‘
12. âœ… å®ç°çŠ¶æ€è¿ç§»ï¼ˆåˆ‡æ¢æ—¶ä¿æŒæ’­æ”¾ï¼‰
13. âœ… å®ç°æ’­æ”¾åˆ—è¡¨ç®¡ç†
14. âœ… å®ç°è¿›åº¦æ‹–åŠ¨
15. âœ… å®ç°éŸ³é‡æ§åˆ¶

#### **Phase 4ï¼šç”¨æˆ·ä½“éªŒ**ï¼ˆå®Œç¾ï¼‰
16. âœ… æ·»åŠ  `audio_service`ï¼ˆåå°æ’­æ”¾ï¼‰
17. âœ… å®ç°åª’ä½“é€šçŸ¥
18. âœ… å®ç°é”å±æ§åˆ¶
19. âœ… å¤„ç†éŸ³é¢‘ç„¦ç‚¹
20. âœ… ç½‘ç»œçŠ¶æ€å¤„ç†

---

## ğŸ¤” **éœ€è¦ä½ å†³ç­–çš„é—®é¢˜**

### 1. **è®¾å¤‡åˆ‡æ¢æ—¶çš„è¡Œä¸º**

**æ–¹æ¡ˆAï¼šè‡ªåŠ¨ç»§ç»­æ’­æ”¾**
- åˆ‡æ¢è®¾å¤‡åï¼Œè‡ªåŠ¨åœ¨æ–°è®¾å¤‡ä¸Šæ’­æ”¾ç›¸åŒæ­Œæ›²
- ä¼˜ç‚¹ï¼šæ— ç¼ä½“éªŒ
- ç¼ºç‚¹ï¼šç”¨æˆ·å¯èƒ½ä¸æƒ³ç«‹å³æ’­æ”¾

**æ–¹æ¡ˆBï¼šæš‚åœçŠ¶æ€**
- åˆ‡æ¢è®¾å¤‡åï¼Œæš‚åœæ’­æ”¾
- ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾
- ä¼˜ç‚¹ï¼šç”¨æˆ·å¯æ§
- ç¼ºç‚¹ï¼šéœ€è¦é¢å¤–æ“ä½œ

**æ–¹æ¡ˆCï¼šè¯¢é—®ç”¨æˆ·**
- å¼¹çª—è¯¢é—®æ˜¯å¦ç»§ç»­æ’­æ”¾
- ä¼˜ç‚¹ï¼šæœ€çµæ´»
- ç¼ºç‚¹ï¼šå¯èƒ½æ‰“æ–­æ“ä½œ

**æˆ‘çš„å»ºè®®ï¼šæ–¹æ¡ˆBï¼ˆæš‚åœçŠ¶æ€ï¼‰** - ç®€å•ã€å®‰å…¨ã€å¯æ§

---

### 2. **æ’­æ”¾åˆ—è¡¨åŒæ­¥**

**æ–¹æ¡ˆAï¼šç‹¬ç«‹ç®¡ç†**
- æœ¬åœ°æ’­æ”¾æœ‰è‡ªå·±çš„æ’­æ”¾åˆ—è¡¨
- éŸ³ç®±æ’­æ”¾æœ‰è‡ªå·±çš„æ’­æ”¾åˆ—è¡¨
- åˆ‡æ¢æ—¶ä¸åŒæ­¥
- ä¼˜ç‚¹ï¼šç®€å•
- ç¼ºç‚¹ï¼šä½“éªŒä¸è¿è´¯

**æ–¹æ¡ˆBï¼šç»Ÿä¸€ç®¡ç†**
- æ’­æ”¾åˆ—è¡¨åœ¨å®¢æˆ·ç«¯ç»Ÿä¸€ç»´æŠ¤
- åˆ‡æ¢è®¾å¤‡æ—¶åŒæ­¥æ’­æ”¾åˆ—è¡¨
- ä¼˜ç‚¹ï¼šä½“éªŒä¸€è‡´
- ç¼ºç‚¹ï¼šå®ç°å¤æ‚

**æˆ‘çš„å»ºè®®ï¼šæ–¹æ¡ˆBï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰** - ä½“éªŒæ›´å¥½

---

### 3. **å®ç°ä¼˜å…ˆçº§**

**å¿«é€ŸåŸå‹ï¼ˆ2-3å¤©ï¼‰ï¼š**
- Phase 1 + Phase 2
- èƒ½æ’­æ”¾ï¼Œä½†åŠŸèƒ½åŸºç¡€

**å¯ç”¨ç‰ˆæœ¬ï¼ˆ1å‘¨ï¼‰ï¼š**
- Phase 1 + Phase 2 + Phase 3
- åŠŸèƒ½å®Œæ•´ï¼Œä½“éªŒæµç•…

**å®Œç¾ç‰ˆæœ¬ï¼ˆ2å‘¨ï¼‰ï¼š**
- å…¨éƒ¨ Phase
- åå°æ’­æ”¾ã€é€šçŸ¥ã€å®Œç¾ä½“éªŒ

**ä½ å¸Œæœ›å…ˆå®ç°åˆ°å“ªä¸ªé˜¶æ®µï¼Ÿ**

---

## ğŸ’­ **æ€»ç»“**

æ ¹æ®ä½ æä¾›çš„æ¥å£ä¿¡æ¯ï¼š
- âœ… **æŠ€æœ¯å®Œå…¨å¯è¡Œ**
- âœ… **æ¥å£å®Œå…¨æ»¡è¶³éœ€æ±‚**
- âœ… **UI å¯ä»¥å®Œå…¨å¤ç”¨**
- âœ… **å®ç°éš¾åº¦ä¸­ç­‰**

æ–¹æ¡ˆå·²ç»éå¸¸æ¸…æ™°äº†ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å†™ä»£ç äº†ï¼

**ä½ è§‰å¾—è¿™ä¸ªè®¾è®¡æ–¹æ¡ˆæ€ä¹ˆæ ·ï¼Ÿæœ‰ä»€ä¹ˆéœ€è¦è°ƒæ•´çš„å—ï¼Ÿç¡®è®¤åæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å®ç°äº†ï¼** ğŸš€