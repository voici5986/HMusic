# è¿›åº¦æ˜¾ç¤ºä¼˜åŒ–æµ‹è¯•æŒ‡å—

## é—®é¢˜æè¿°
- **é—®é¢˜1**: é¦–é¡µæ§åˆ¶å¡ç‰‡åœ¨æ•°æ®åŠ è½½å®Œæˆå‰æ˜¾ç¤ºä¸å®Œæ•´ï¼Œé€ æˆè§†è§‰å‰²è£‚æ„Ÿ
- **é—®é¢˜2**: åˆ‡æ¢æ­Œæ›²åï¼Œè¿›åº¦æ˜¾ç¤ºä¸æ­£ç¡®ï¼ˆä¾‹å¦‚Aæ­Œæ›²40ç§’æ—¶åˆ‡æ¢åˆ°Bæ­Œæ›²ï¼ŒBæ­Œæ›²è¿›åº¦ä»40ç§’å¼€å§‹è€Œé0ç§’ï¼‰

## ä¼˜åŒ–å†…å®¹

### 1. é¦–é¡µåŠ è½½ä¼˜åŒ– âœ…
- **ç§»é™¤å»¶è¿ŸåŠ è½½**: ä»500mså»¶è¿Ÿæ”¹ä¸ºé¦–å¸§åç«‹å³åŠ è½½
- **è®¾å¤‡åŒºåŸŸå§‹ç»ˆæ˜¾ç¤º**: 
  - åŠ è½½ä¸­: æ˜¾ç¤º"æ­£åœ¨åŠ è½½è®¾å¤‡..."å ä½ç¬¦
  - æœ‰è®¾å¤‡: æ˜¾ç¤ºè®¾å¤‡é€‰æ‹©å™¨
  - æ— è®¾å¤‡: æ˜¾ç¤ºæç¤ºä¿¡æ¯
- **å›ºå®šå¸ƒå±€é«˜åº¦**: é¿å…æ•°æ®åŠ è½½å®Œæˆåå¸ƒå±€è·³åŠ¨

### 2. æ­Œæ›²åˆ‡æ¢è¿›åº¦ä¿®å¤ âœ…
- **è‡ªåŠ¨æ£€æµ‹æ­Œæ›²åˆ‡æ¢**: é€šè¿‡æ­Œæ›²åç§°å¯¹æ¯”æ£€æµ‹åˆ‡æ¢
- **é‡ç½®è¿›åº¦åŸºå‡†**: åˆ‡æ¢æ­Œæ›²æ—¶ç«‹å³é‡ç½® `_lastServerOffset` å’Œ `_lastUpdateTime`
- **æ¸…é™¤æ—§å°é¢**: åˆ‡æ¢æ­Œæ›²æ—¶æ¸…é™¤æ—§çš„ä¸“è¾‘å°é¢URLï¼Œç­‰å¾…åŠ è½½æ–°å°é¢

## æµ‹è¯•æ­¥éª¤

### æµ‹è¯•1: é¦–é¡µåŠ è½½æµç•…åº¦
1. å®Œå…¨é€€å‡ºåº”ç”¨
2. é‡æ–°å¯åŠ¨åº”ç”¨å¹¶ç™»å½•
3. è§‚å¯Ÿé¦–é¡µæ§åˆ¶å¡ç‰‡çš„æ˜¾ç¤ºè¿‡ç¨‹
4. **é¢„æœŸç»“æœ**: 
   - å¡ç‰‡ç«‹å³æ˜¾ç¤ºå®Œæ•´æ¡†æ¶
   - è®¾å¤‡åŒºåŸŸæ˜¾ç¤ºåŠ è½½æç¤º
   - æ— æ˜æ˜¾çš„å¸ƒå±€è·³åŠ¨æˆ–é—ªçƒ
   - æ•°æ®å¡«å……è¿‡ç¨‹å¹³æ»‘è‡ªç„¶

### æµ‹è¯•2: æ­Œæ›²åˆ‡æ¢è¿›åº¦æ­£ç¡®æ€§
1. åœ¨æ§åˆ¶é¡µæ’­æ”¾æ­Œæ›²A
2. ç­‰å¾…æ­Œæ›²Aæ’­æ”¾åˆ° 30-40 ç§’
3. åˆ‡æ¢åˆ°æœç´¢é¡µé¢
4. æœç´¢å¹¶æ’­æ”¾æ­Œæ›²B
5. ç«‹å³åˆ‡å›æ§åˆ¶é¡µé¢
6. **é¢„æœŸç»“æœ**: 
   - è¿›åº¦æ¡æ˜¾ç¤ºä» 0 ç§’å¼€å§‹ï¼ˆæˆ–æœåŠ¡å™¨è¿”å›çš„å®é™…è¿›åº¦ï¼‰
   - ä¸ä¼šæ˜¾ç¤ºæ—§æ­Œæ›²Açš„è¿›åº¦ï¼ˆ40ç§’ï¼‰
   - å°é¢å›¾æ­£ç¡®æ˜¾ç¤ºä¸ºæ­Œæ›²Bçš„å°é¢ï¼ˆæˆ–é»˜è®¤å›¾æ ‡ï¼‰

### æµ‹è¯•3: è¿›åº¦é¢„æµ‹å‡†ç¡®æ€§
1. æ’­æ”¾ä»»æ„æ­Œæ›²
2. è§‚å¯Ÿè¿›åº¦æ¡æ¯ç§’çš„å˜åŒ–
3. ç­‰å¾…è‡ªåŠ¨åˆ·æ–°ï¼ˆçº¦5-8ç§’ï¼‰
4. **é¢„æœŸç»“æœ**: 
   - æœ¬åœ°è¿›åº¦å¹³æ»‘é€’å¢
   - æœåŠ¡å™¨åˆ·æ–°æ—¶æ— æ˜æ˜¾è·³è·ƒ
   - è¿›åº¦ä¸å®é™…æ’­æ”¾æ—¶é—´ä¸€è‡´

## æŠ€æœ¯å®ç°

### æ ¸å¿ƒæ”¹åŠ¨

#### 1. `control_panel_page.dart`
```dart
// ç§»é™¤å»¶è¿Ÿï¼Œç«‹å³å¼€å§‹åŠ è½½
WidgetsBinding.instance.addPostFrameCallback((_) {
  // åŠ è½½è®¾å¤‡å’Œæ’­æ”¾çŠ¶æ€
});

// æ–°å¢è®¾å¤‡åŒºåŸŸç®¡ç†
Widget _buildDeviceArea(DeviceState deviceState) {
  if (deviceState.isLoading && deviceState.devices.isEmpty) {
    return _buildDeviceLoadingPlaceholder(); // åŠ è½½å ä½ç¬¦
  } else if (deviceState.devices.isNotEmpty) {
    return _buildDeviceSelector(deviceState); // è®¾å¤‡é€‰æ‹©å™¨
  } else {
    return _buildNoDeviceHint(); // æ— è®¾å¤‡æç¤º
  }
}
```

#### 2. `playback_provider.dart`
```dart
// æ£€æµ‹æ­Œæ›²åˆ‡æ¢
bool isSongChanged = false;
if (state.currentMusic != null && currentMusic != null) {
  final oldSongName = state.currentMusic!.curMusic;
  final newSongName = currentMusic.curMusic;
  if (oldSongName != newSongName) {
    isSongChanged = true;
    print('ğŸµ æ£€æµ‹åˆ°æ­Œæ›²åˆ‡æ¢: "$oldSongName" -> "$newSongName"');
  }
}

// æ­Œæ›²åˆ‡æ¢æ—¶é‡ç½®è¿›åº¦åŸºå‡†
if (isSongChanged) {
  needsRecalibration = true;
  print('ğŸ”„ æ­Œæ›²å·²åˆ‡æ¢ï¼Œé‡ç½®è¿›åº¦åŸºå‡†');
}

// æ¸…é™¤æ—§å°é¢
state = state.copyWith(
  currentMusic: currentMusic,
  volume: volume,
  error: null,
  isLoading: silent ? state.isLoading : false,
  hasLoaded: true,
  albumCoverUrl: isSongChanged ? null : state.albumCoverUrl, // åˆ‡æ¢æ­Œæ›²æ—¶æ¸…é™¤
);
```

## å·²çŸ¥é™åˆ¶
- å°é¢å›¾è·å–ä¾èµ–äºéŸ³æºAPIæˆ–JSè„šæœ¬ï¼Œå¯èƒ½æœ‰å»¶è¿Ÿ
- è¿›åº¦åŒæ­¥ä¾èµ–äºæœåŠ¡å™¨åˆ·æ–°é—´éš”ï¼ˆ5-8ç§’ï¼‰
- æå¿«é€Ÿè¿ç»­åˆ‡æ­Œå¯èƒ½æœ‰çŸ­æš‚çš„çŠ¶æ€ä¸ä¸€è‡´

## åç»­ä¼˜åŒ–å»ºè®®
- [ ] è€ƒè™‘æ·»åŠ å°é¢é¢„åŠ è½½æœºåˆ¶
- [ ] ä¼˜åŒ–å¤šæ¬¡å¿«é€Ÿåˆ‡æ­Œçš„ä½“éªŒ
- [ ] æ·»åŠ åˆ‡æ­ŒåŠ¨ç”»æ•ˆæœ

